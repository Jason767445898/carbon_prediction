# ⚙️ 项目配置说明

> AI碳价格预测系统配置参考手册  
> **版本**: v1.0 | **更新日期**: 2025-10-17

---

## 📋 目录

1. [全局配置](#全局配置)
2. [模型配置](#模型配置)
3. [数据配置](#数据配置)
4. [输出配置](#输出配置)
5. [环境变量](#环境变量)
6. [配置示例](#配置示例)

---

## 🌐 全局配置

### 默认配置位置

主配置在 `carbon_price_prediction.py` 第43行开始：

```python
DEFAULT_CONFIG = {
    'target_column': 'carbon_price',     # 目标列名
    'sequence_length': 60,               # 序列长度
    'test_size': 0.2,                   # 测试集比例
    'validation_size': 0.1,             # 验证集比例
    'random_state': 42,                 # 随机种子
}
```

### 配置参数详解

| 参数 | 类型 | 默认值 | 说明 | 可选范围 |
|------|------|--------|------|---------|
| `target_column` | str | 'carbon_price' | 预测目标列名 | 数据中的任意列名 |
| `sequence_length` | int | 60 | 时间序列长度 | 30-120 |
| `test_size` | float | 0.2 | 测试集比例 | 0.1-0.3 |
| `validation_size` | float | 0.1 | 验证集比例 | 0.05-0.15 |
| `random_state` | int | 42 | 随机种子 | 任意整数 |

---

## 🤖 模型配置

### LSTM 配置

```python
'lstm_config': {
    'units': [64, 32],          # 每层神经元数
    'dropout': 0.2,             # Dropout率
    'epochs': 100,              # 训练轮数
    'batch_size': 32,           # 批处理大小
    'learning_rate': 0.001,     # 学习率（可选）
}
```

#### 参数说明

| 参数 | 说明 | 推荐值 | 调优范围 |
|------|------|--------|---------|
| **units** | LSTM层神经元数量列表 | [64, 32] | 16-256 |
| **dropout** | 防止过拟合的随机失活率 | 0.2 | 0.1-0.5 |
| **epochs** | 训练轮数 | 100 | 50-200 |
| **batch_size** | 批处理大小 | 32 | 8-128 |

#### 配置策略

**小数据集（<1000样本）**
```python
'lstm_config': {
    'units': [32, 16],
    'dropout': 0.3,
    'epochs': 100,
    'batch_size': 8
}
```

**大数据集（>5000样本）**
```python
'lstm_config': {
    'units': [128, 64, 32],
    'dropout': 0.2,
    'epochs': 200,
    'batch_size': 128
}
```

**快速测试**
```python
'lstm_config': {
    'units': [32, 16],
    'dropout': 0.2,
    'epochs': 50,
    'batch_size': 16
}
```

**高性能**
```python
'lstm_config': {
    'units': [256, 128, 64],
    'dropout': 0.3,
    'epochs': 300,
    'batch_size': 64
}
```

### Transformer 配置

```python
'transformer_config': {
    'd_model': 128,             # 模型维度
    'num_heads': 8,             # 注意力头数
    'num_layers': 4,            # 编码器层数
    'dff': 512,                 # 前馈网络维度
    'dropout': 0.1,             # Dropout率
    'epochs': 50,               # 训练轮数
    'batch_size': 32,           # 批处理大小
}
```

#### 参数说明

| 参数 | 说明 | 推荐值 | 约束条件 |
|------|------|--------|---------|
| **d_model** | 模型隐藏层维度 | 128 | 必须能被num_heads整除 |
| **num_heads** | 多头注意力的头数 | 8 | d_model的因子 |
| **num_layers** | Transformer编码器层数 | 4 | 2-8 |
| **dff** | 前馈网络维度 | 512 | 通常为d_model的2-4倍 |
| **dropout** | Dropout率 | 0.1 | 0.05-0.6 |

#### 配置策略

**轻量级（避免过拟合）**
```python
'transformer_config': {
    'd_model': 16,
    'num_heads': 2,
    'num_layers': 2,
    'dff': 64,
    'dropout': 0.6,
    'epochs': 100,
    'batch_size': 8
}
```

**标准配置**
```python
'transformer_config': {
    'd_model': 128,
    'num_heads': 8,
    'num_layers': 4,
    'dff': 512,
    'dropout': 0.1,
    'epochs': 50,
    'batch_size': 32
}
```

**高性能**
```python
'transformer_config': {
    'd_model': 256,
    'num_heads': 16,
    'num_layers': 6,
    'dff': 1024,
    'dropout': 0.2,
    'epochs': 100,
    'batch_size': 64
}
```

---

## 📊 数据配置

### 文件路径配置

```python
# 数据文件路径（在代码中修改）
DEFAULT_DATA_FILE = 'data.dta'
SAMPLE_DATA_FILE = 'carbon_price_test_data.xlsx'
```

### 输出目录配置

```python
OUTPUT_DIRS = {
    'txt': 'outputs/logs',              # 文本日志
    'excel': 'outputs/reports',         # Excel报告
    'pic': 'outputs/visualizations'     # 可视化图表
}
```

### 文件命名格式

```python
FILE_NAME_FORMAT = {
    'program_name': 'carbon_price_prediction',
    'timestamp_format': '%Y%m%d_%H%M%S'
}
```

---

## 📤 输出配置

### 报告生成选项

```python
# 在主程序中设置
GENERATE_REPORT = True          # 生成详细报告
GENERATE_VISUALIZATIONS = True  # 生成可视化图表
SAVE_PREDICTIONS = True         # 保存预测结果
```

### 可视化配置

```python
# 图表尺寸和样式
FIGURE_SIZE = (12, 8)
DPI = 100
STYLE = 'seaborn'
```

---

## 🌍 环境变量

### Python 环境

```bash
# Python 版本要求
PYTHON_VERSION >= 3.7

# 推荐使用虚拟环境
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
```

### 系统环境变量（可选）

```bash
# TensorFlow 配置
export TF_CPP_MIN_LOG_LEVEL=2  # 减少TensorFlow日志输出

# GPU 配置（如果使用）
export CUDA_VISIBLE_DEVICES=0  # 指定使用的GPU

# 线程数配置
export OMP_NUM_THREADS=4       # OpenMP线程数
```

### macOS 特殊配置

```bash
# 安装 OpenMP（必须！）
brew install libomp

# 防休眠运行（长时间任务）
caffeinate -i python3 carbon_price_prediction.py
```

---

## 📝 配置示例

### 示例1：基础使用

```python
from carbon_price_prediction import CarbonPricePredictionSystem

# 使用默认配置
system = CarbonPricePredictionSystem()
system.run_complete_analysis('data.xlsx')
```

### 示例2：自定义目标列

```python
config = {
    'target_column': 'coal_price'  # 使用不同的目标列
}
system = CarbonPricePredictionSystem(config=config)
system.run_complete_analysis('data.dta')
```

### 示例3：优化LSTM性能

```python
config = {
    'target_column': 'carbon_price',
    'sequence_length': 90,
    'lstm_config': {
        'units': [128, 64],
        'dropout': 0.3,
        'epochs': 150,
        'batch_size': 16
    }
}
system = CarbonPricePredictionSystem(config=config)
system.run_complete_analysis('data.xlsx')
```

### 示例4：快速测试配置

```python
config = {
    'sequence_length': 30,
    'lstm_config': {
        'units': [32, 16],
        'epochs': 20,  # 快速测试
        'batch_size': 16
    },
    'transformer_config': {
        'd_model': 64,
        'num_heads': 4,
        'num_layers': 2,
        'epochs': 10
    }
}
system = CarbonPricePredictionSystem(config=config)
system.run_complete_analysis('data.xlsx')
```

### 示例5：生产环境配置

```python
config = {
    'target_column': 'carbon_price',
    'sequence_length': 60,
    'test_size': 0.15,
    'validation_size': 0.1,
    'random_state': 42,
    'lstm_config': {
        'units': [72, 36],
        'dropout': 0.16,
        'epochs': 140,
        'batch_size': 8
    },
    'transformer_config': {
        'd_model': 16,
        'num_heads': 2,
        'num_layers': 2,
        'dff': 64,
        'dropout': 0.6,
        'epochs': 100,
        'batch_size': 8
    }
}
system = CarbonPricePredictionSystem(config=config)
system.run_complete_analysis('production_data.dta')
```

---

## 🔧 配置文件管理

### 创建独立配置文件

建议创建 `config.py` 统一管理配置：

```python
# config.py
PRODUCTION_CONFIG = {
    'target_column': 'carbon_price',
    'sequence_length': 60,
    'lstm_config': {
        'units': [72, 36],
        'dropout': 0.16,
        'epochs': 140,
        'batch_size': 8
    },
    'transformer_config': {
        'd_model': 16,
        'num_heads': 2,
        'num_layers': 2,
        'dff': 64,
        'dropout': 0.6,
        'epochs': 100
    }
}

TESTING_CONFIG = {
    'sequence_length': 30,
    'lstm_config': {
        'epochs': 20,
        'batch_size': 16
    }
}
```

### 使用配置文件

```python
from config import PRODUCTION_CONFIG
from carbon_price_prediction import CarbonPricePredictionSystem

system = CarbonPricePredictionSystem(config=PRODUCTION_CONFIG)
system.run_complete_analysis('data.xlsx')
```

---

## 📊 性能调优建议

### 根据数据量调整

| 数据量 | sequence_length | batch_size | epochs |
|--------|----------------|-----------|--------|
| < 500 | 30 | 8 | 100 |
| 500-1000 | 60 | 16 | 150 |
| 1000-5000 | 60 | 32 | 200 |
| > 5000 | 120 | 64 | 300 |

### 根据硬件调整

**8GB 内存**
```python
config = {
    'lstm_config': {'batch_size': 16, 'units': [32, 16]},
    'transformer_config': {'d_model': 64, 'batch_size': 8}
}
```

**16GB+ 内存**
```python
config = {
    'lstm_config': {'batch_size': 64, 'units': [128, 64]},
    'transformer_config': {'d_model': 256, 'batch_size': 32}
}
```

**有 GPU**
```python
config = {
    'lstm_config': {'batch_size': 128, 'epochs': 500},
    'transformer_config': {'batch_size': 64, 'epochs': 200}
}
```

---

## ⚠️ 常见配置错误

### 错误1：num_heads 不能整除 d_model

```python
# ❌ 错误
'transformer_config': {
    'd_model': 100,
    'num_heads': 8  # 100 不能被 8 整除
}

# ✅ 正确
'transformer_config': {
    'd_model': 128,  # 128 = 8 × 16
    'num_heads': 8
}
```

### 错误2：batch_size 过大导致内存溢出

```python
# ❌ 内存不足时
'lstm_config': {'batch_size': 256}

# ✅ 减小 batch_size
'lstm_config': {'batch_size': 16}
```

### 错误3：目标列名不匹配

```python
# ❌ 列名错误
config = {'target_column': 'carbon_price'}  # 但数据中是 'coal_price'

# ✅ 使用正确列名
config = {'target_column': 'coal_price'}
```

---

## 📚 相关文档

- 📖 [详细使用指南](./碳价格预测系统使用指南.md)
- 🔧 [参数调优指南](./参数调优完整指南.md)
- 🐛 [问题诊断报告](./参数不一致问题诊断报告.md)

---

**文档版本**: v1.0  
**最后更新**: 2025-10-17  
**维护团队**: AI Research Team
