# LSTM+Attention 碳价格预测模型 - 优化版本1备份

**备份时间**: 2025-10-24 23:40  
**训练完成时间**: 2025-10-24 23:40:51  
**文件**: `lstm_attention_carbon_prediction.py`

---

## 📊 训练结果总结

### 性能指标
| 指标 | 数值 | 评估 |
|------|------|------|
| **R²** | -0.2823 | ❌ 仍为负值，但比优化前的-54.46大幅改善 |
| **MAPE** | 4.81% | ✅ 优秀！比优化前的36.24%大幅降低 |
| **MAE** | 2.1838 | ✅ 较好，比优化前的16.66显著降低 |
| **RMSE** | 2.5534 | ✅ 较好，比优化前的16.75显著降低 |
| **方向准确率** | 53.74% | ⚠️ 略高于随机，仍需提升 |

### 关键发现
1. ✅ **MAPE降至4.81%** - 平均百分比误差显著降低
2. ✅ **绝对误差大幅下降** - MAE从16.66降至2.18
3. ⚠️ **R²仍为负** - 模型拟合度不足，但比之前好很多
4. ⚠️ **方向准确率仅53.74%** - 方向预测能力有限
5. ⚠️ **过度依赖price_lag_1** - SHAP重要性15.86，远超其他特征

---

## 🔧 当前模型配置

### 核心参数
```python
CONFIG = {
    'data_file': 'data.dta',
    'target_column': 'carbon_price_hb_ea',
    'sequence_length': 90,              # 序列长度
    'test_size': 0.2,
    'validation_size': 0.1,
    'epochs': 300,                      # 训练轮数
    'batch_size': 16,                   # 批次大小
    'learning_rate': 0.0001,            # 初始学习率
    'lstm_units': 256,                  # 第一层LSTM单元数
    'lstm_units_2': 128,                # 第二层LSTM单元数
    'lstm_units_3': 64,                 # 第三层LSTM单元数
    'attention_dim': 128,               # 注意力维度
    'dropout_rate': 0.4,                # Dropout比率
    'l2_reg': 0.001,                    # L2正则化系数
    'gradient_clip': 1.0,               # 梯度裁剪阈值
}
```

### 模型架构
- **输入**: (90, 49) - 90个时间步，49个特征
- **LSTM层**: 
  - Layer 1: 256 units (dropout=0.2, recurrent_dropout=0.1) + BatchNorm
  - Layer 2: 128 units (dropout=0.2, recurrent_dropout=0.1) + BatchNorm
  - Layer 3: 64 units (dropout=0.2, recurrent_dropout=0.1) + BatchNorm
- **Attention层**: 128维注意力机制
- **Dense层**:
  - Dense 1: 128 units + BatchNorm + Dropout(0.4)
  - Dense 2: 64 units + BatchNorm + Dropout(0.4)
  - Dense 3: 32 units + Dropout(0.2)
  - Output: 1 unit
- **总参数量**: 589,570 (2.25 MB)
- **可训练参数**: 588,290

### 损失函数
```python
def directional_loss(y_true, y_pred):
    # 80% Huber损失 + 20% 方向损失
    huber = tf.keras.losses.Huber(delta=1.0)(y_true, y_pred)
    # 方向损失计算（带NaN保护）
    direction_component = compute_direction_loss()
    return 0.8 * huber + 0.2 * direction_component
```

### 优化器配置
- **类型**: Adam
- **学习率调度**: CosineDecay
  - 初始学习率: 0.0001
  - 最终学习率: 5e-06 (alpha=0.05)
  - 衰减步数: 15,000 (300 epochs × 50 steps)
- **梯度裁剪**: clipnorm=1.0

### 训练回调
- **EarlyStopping**: patience=40, min_delta=1e-5
- **ReduceLROnPlateau**: patience=20, factor=0.5, min_lr=1e-8
- **ModelCheckpoint**: 保存最佳模型到 `outputs/models/best_model.keras`

---

## 📈 训练过程

### 训练曲线关键点
- **Epoch 1**: val_loss=1.5756, val_mae=0.7159
- **Epoch 100**: 损失持续下降，学习率逐步衰减
- **Epoch 200**: 进入精细调优阶段
- **Epoch 294**: 最佳模型 (val_loss=0.4284)
- **Epoch 300**: 训练完成，恢复最佳权重

### 最佳Epoch (294)
- **val_loss**: 0.4284
- **val_mae**: 0.0583
- **val_mse**: 0.0053
- **learning_rate**: 5.0937e-06

### 训练稳定性
- ✅ 无NaN损失
- ✅ 验证损失平稳下降
- ✅ 无过拟合迹象（训练损失和验证损失趋势一致）
- ⚠️ 学习率衰减至5e-06，可能过早收敛

---

## 🔍 SHAP特征重要性

| 特征 | 重要性 | 占比 |
|------|--------|------|
| price_lag_1 | 15.863 | **78.5%** |
| ma_10 | 1.191 | 5.9% |
| ma_5 | 0.744 | 3.7% |
| ema_26 | 0.337 | 1.7% |
| ema_12 | 0.291 | 1.4% |
| price_lag_2 | 0.273 | 1.3% |
| gas_price | 0.195 | 1.0% |
| log_gas_price | 0.190 | 0.9% |
| log_gas_price_sqr | 0.181 | 0.9% |
| price_lag_3 | 0.144 | 0.7% |

**关键问题**: price_lag_1占据78.5%的重要性，模型过度依赖最近一期价格，未充分学习其他特征的模式。

---

## 🎯 优化前后对比

| 指标 | 优化前 | 优化后 | 变化 |
|------|--------|--------|------|
| **R²** | -54.46 | -0.28 | ✅ +99.5% |
| **MAPE** | 36.24% | 4.81% | ✅ -86.7% |
| **MAE** | 16.66 | 2.18 | ✅ -86.9% |
| **RMSE** | 16.75 | 2.55 | ✅ -84.8% |
| **方向准确率** | 49.79% | 53.74% | ✅ +7.9% |

---

## 💡 问题诊断

### 1. R²为负的原因
- **定义**: R² = 1 - (SS_res / SS_tot)
- **负值含义**: 模型预测比简单平均值还差
- **可能原因**:
  - 验证集上的损失计算与R²计算不一致
  - 模型在训练集上过拟合，泛化能力不足
  - 测试集分布与训练集差异较大
  - 损失函数优化方向与R²不完全一致（方向损失成分）

### 2. 过度依赖price_lag_1
- **现象**: SHAP重要性15.86，占比78.5%
- **原因**:
  - 最近一期价格信息量最大，模型"懒惰"选择
  - 其他特征的信号被噪声淹没
  - 技术指标的滞后性导致信息冗余
  - Attention机制未能有效分散关注

### 3. 方向准确率低
- **现状**: 53.74%，仅略高于随机
- **原因**:
  - 方向损失权重仅20%，不足以驱动方向学习
  - 价格序列的随机游走特性
  - 训练数据量不足以学习复杂的方向模式

---

## 📁 输出文件

- **Excel报告**: `outputs/reports/20251024_234051_carbon_prediction_report.xlsx`
- **TXT报告**: `outputs/logs/20251024_234051_analysis_report.txt`
- **可视化图表**: `outputs/visualizations/`
- **最佳模型**: `outputs/models/best_model.keras`

---

## 🔄 版本控制

- **Git提交**: 建议提交当前版本
- **标签**: v1.0-optimized-lstm-attention
- **分支**: feature/lstm-attention-optimization

---

## 📝 备注

1. 此版本在MAPE和绝对误差上取得显著进步
2. R²仍为负，需要进一步优化模型结构和训练策略
3. 特征工程需要重点关注，避免price_lag_1主导
4. 下一步优化应聚焦于提升R²和方向准确率
